<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="www.thymeleaf.org"
      layout:decorate="~{layout/layout.html}"
>
<body>
<div layout:fragment="content">

  <div class="card-header">
    <h2>cafe 공간 예약 수정 및 결제하기</h2>
  </div>
  <div class="card-body">

  <form id="reservationForm"  method="post">

    <label class="form-control">결제 상태:</label>
    <div class="input-group mb-3">
      <input class="form-control" type="text"  id="payStatus" name="payStatus"    th:value="${reservationItem.payStatus}" readonly/>
    </div>


    <input class="form-control" type="hidden"  id="reservationItemId" name="reservationItemId"    th:value="${reservationItem.id}" readonly/>
    <input class="form-control" type="text"  id="reservationAddress" name="reservationAddress"    th:value="${reservationAddress}" readonly/>
    <input class="form-control" type="text"  id="reservationPhone" name="reservationPhone"    th:value="${reservationPhone}" readonly/>
    <input class="form-control" type="hidden"  id="reservationName2" name="reservationName2"    th:value="${user2.name}" readonly/>



    <label class="form-control">예약 가능 시간만 표기, 테이블 필요,상품과 예약시간, 1시간 단위로, 예) 9:00~10:00:</label>
    <div class="input-group mb-3">
    <input class="form-control" type="date"  id="reservationDate" name="reservationDate"    th:value="${reservationItem.reservation.reservationDate}" />
    </div>

    <div class="form-group">
      <select id="reservationTime" class="form-control" name="reservationTime" >
        <option value="">==예약 시간 선택==</option>
        <option th:each="i : ${#numbers.sequence(0, 23)}"
                th:value="${i}"
                th:text="${i} + ':00 ~ ' + ${i + 1} + ':00'"
                th:selected="${i} == ${reservationTime}"
                >
        </option>
      </select>
    </div>

    <label class="form-control">Number of Guests :</label>
    <div class="input-group mb-3">
      <input class="form-control" type="number"  id="reservationCount" name="reservationCount"
             th:value="${reservationItem.numberOfGuests}"
             min="1" />
    </div>
    <label class="form-control">선택 된 상품명 :</label>
    <div class="input-group mb-3">
      <input class="form-control" type="text" id="selectedItemName" name = "selectedItemName" th:value="${reservationItem.item.name}" readonly  />
    </div>
    <label class="form-control">선택 된 상품 가격 :</label>
    <div class="input-group mb-3">
      <input class="form-control" type="text" id="selectedItemPrice" th:value="${reservationItem.item.price}" readonly  />
    </div>

    <div class="input-group mb-3">
<!--    th:field  전송시 user.id 로 제출이 됨-->
      <!--        th:value       제출 될 값-->
      <!--    th:text  화면에 표시 될 값-->
      <div class="form-group">
        <label for="reservationName">예약자 :</label>
        <select id="reservationName" class="form-control" name="reservationName">
          <option th:each="user : ${users}"
                  th:if="${user != null} and ${user2 != null} and ${user.id == user2.id}"
                  th:value="${user.username}"
                  th:text="${user.name}">
          </option>
        </select>
      </div>
    </div>
    <button id="updateReservation" class="btn btn-primary w-100 submitBtn" type="submit">수정하기</button>
    <button id="cancleReservation" class="btn btn-warning w-100 submitBtn" type="submit">취소하기</button>
    <button id="payReservation" class="btn btn-danger w-100 submitBtn" type="submit">결제하기</button>

  </form>
    <!--  상품넣기, 레스트로-->
    <!-- Container for items -->
    <div class="container mt-4" id="jsonResult"></div>

    <!-- Pagination -->
    <div class="pagination justify-content-center" id="paginationContainer"></div>

  </div>




</div>

<!--자바스크립트 추가하는 영역-->
<script layout:fragment="javascript" th:inline="javascript">
  $(document).ready(function() {
    // Function to fetch paginated items
    function fetchItems(pageNumber = 0, pageSize = 6) {
      $.ajax({
        url: `/api/items/page?page=${pageNumber}&size=${pageSize}`,
        type: 'GET',
        headers: {
          "Authorization": "Bearer " + localStorage.getItem("accessToken")},
        dataType: 'json',
        success: function(response) {
          let itemsHtml = '';
          let paginationHtml = '';

          const startPage = Math.max(0, pageNumber - 5);
          const endPage = Math.min(response.totalPages - 1, pageNumber + 4);


          // Loop through the items and create the HTML for the items
          $.each(response.content, function(index, item) {

            itemsHtml += `
              <div class="col">
                <div class="card h-100 text-center">
                  <div class="card-img-top" style="height: 300px; min-height: 300px; overflow: hidden;">
                    ${item.itemRepImageId ?
                    `<img src="/items/${item.id}/itemImage?id=${item.itemRepImageId}" alt="Item Image" class="img-fluid" style="height: 100%; width: 100%; object-fit: fill;">` :
                    `<div style="height: 200px; display: flex; justify-content: center; align-items: center;"><p>No item image uploaded.</p></div>`
            }
                  </div>
                  <div class="card-body">
                    <h5 class="card-title">${item.name}</h5>
                    <p class="card-text">Price: ${item.price}</p>
                    <p class="card-text">${item.description}</p>
                  </div>
                  <div class="card-footer">
                    <a href="/items/${item.id}/detail" class="btn btn-primary">상세보기</a>
                  <a class="selectReservation btn btn-warning" data-name="${item.name}" data-price="${item.price}">예약선택</a>
                  </div>
                </div>
              </div>`;
          });

          // Insert items into the result container
          $('#jsonResult').html(`
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
              ${itemsHtml}
            </div>
          `);

          // Generate pagination links
          if (response.totalPages > 1) {
            paginationHtml += `<ul class="pagination justify-content-center">`;

            // First page link
            if (pageNumber > 0) {
              paginationHtml += `<li class="page-item"><a href="#" class="page-link" data-page="0" data-size="${pageSize}">First</a></li>`;
            }

            // Previous page link
            if (pageNumber > 0) {
              paginationHtml += `<li class="page-item"><a href="#" class="page-link" data-page="${pageNumber - 1}" data-size="${pageSize}">Previous</a></li>`;
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
              paginationHtml += `<li class="page-item ${i === pageNumber ? 'active' : ''}">
                                  <a href="#" class="page-link" data-page="${i}" data-size="${pageSize}">${i + 1}</a></li>`;
            }

            // Next page link
            if (pageNumber < response.totalPages - 1) {
              paginationHtml += `<li class="page-item"><a href="#" class="page-link" data-page="${pageNumber + 1}" data-size="${pageSize}">Next</a></li>`;
            }

            // Last page link
            if (pageNumber < response.totalPages - 1) {
              paginationHtml += `<li class="page-item"><a href="#" class="page-link" data-page="${response.totalPages - 1}" data-size="${pageSize}">Last</a></li>`;
            }

            paginationHtml += `</ul>`;
          }

          // Insert pagination into the pagination container
          $('#paginationContainer').html(paginationHtml);
        },
        error: function(xhr, status, error) {
          console.error('Error fetching items:', error);
        }
      });


    }

    // Initial load (fetch the first page with 6 items per page)
    fetchItems(0, 10);

    // Handle pagination click event
    $(document).on('click', '.page-link', function(e) {
      e.preventDefault(); // Prevent default link behavior
      const page = $(this).data('page');
      const size = $(this).data('size');
      fetchItems(page, size); // Fetch the items for the clicked page
    });

    // 예약 선택 버튼 클릭 시 이벤트 핸들러
    // 동적으로 생성된 .selectReservation 클래스 버튼에 이벤트 핸들러 추가
    $(document).on('click', '.selectReservation', function() {
      // 버튼의 data-name과 data-price 속성에서 값 가져오기
      const productName = $(this).data('name');
      const productPrice = $(this).data('price');

      // 값 설정
      $('#selectedItemName').val(productName);
      $('#selectedItemPrice').val(productPrice);
    });


    // 예약 취소
    $(document).on('click', '#cancleReservation', function (e) {
      e.preventDefault(); // 기본 폼 제출 방지

      Swal.fire({
        title: "예약 취소할까요?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, cancel it!"
      }).then((result) => {
        if (result.isConfirmed) {

            const id = $('#reservationItemId').val()


          // AJAX 요청
          $.ajax({
            url: '/api/reservation-items/'+id, // 전송할 URL (Thymeleaf에서 설정한 엔드포인트)
            type: 'DELETE',
            contentType: 'application/json', // JSON 타입으로 전송
            dataType: 'json', // 서버에서 JSON 형식의 응답을 기대
            headers: {
              "Authorization": "Bearer " + localStorage.getItem("accessToken")
            },
            success: function (response) {
              // 성공 시 처리할 동작
              Swal.fire({
                title: '예약 취소 완료. 감사합니다.',
                icon: 'success',
                imageUrl: 'https://unsplash.it/400/200',  // 원하시는 이미지 URL로 교체 가능
                imageWidth: 400,
                imageHeight: 200,
                imageAlt: 'Custom image'
              }).then(() => {
                window.location.href = '/reservation-items';
              });
              console.log(response);
            },
            error: function (error) {
              // 에러 시 처리할 동작
              Swal.fire({
                title: '오류!',
                text: '예약 처리 중 오류가 발생했습니다.',
                icon: 'error'
              });
              console.log(error);
            }
          });
        } else {
          // 취소 선택 시 추가적인 동작이 필요하면 이곳에 추가
          Swal.fire({
            title: "취소됨!",
            text: "예약이 취소되었습니다.",
            icon: "info"
          });
        }
      });
    }); //예약취소 end

    // 예약 수정하기
    $(document).on('click', '#updateReservation', function (e) {
      e.preventDefault(); // 기본 폼 제출 방지

      Swal.fire({
        title: "예약 수정할까요?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, update it!"
      }).then((result) => {
        if (result.isConfirmed) {

          const id = $('#reservationItemId').val()

          const dataToSend = {
            reservationTime: $('#reservationTime').val(),
            reservationDate: $('#reservationDate').val(),
            reservationCount: $('#reservationCount').val(),
            selectedItemName: $('#selectedItemName').val(),
            selectedItemPrice: $('#selectedItemPrice').val(),
            reservationName: $('#reservationName').val()
          };

          // AJAX 요청
          $.ajax({
            url: '/api/reservation-items/'+id, // 전송할 URL (Thymeleaf에서 설정한 엔드포인트)
            type: 'PUT',
            contentType: 'application/json', // JSON 타입으로 전송
            dataType: 'json', // 서버에서 JSON 형식의 응답을 기대
            headers: {
              "Authorization": "Bearer " + localStorage.getItem("accessToken")
            },
            data: JSON.stringify(dataToSend),
            success: function (response) {
              // 성공 시 처리할 동작
              Swal.fire({
                title: '예약 수정 완료. 감사합니다.',
                icon: 'success',
                imageUrl: 'https://unsplash.it/400/200',  // 원하시는 이미지 URL로 교체 가능
                imageWidth: 400,
                imageHeight: 200,
                imageAlt: 'Custom image'
              }).then(() => {
                window.location.href = '/reservation-items';
              });
              console.log(response);
            },
            error: function (error) {
              // 에러 시 처리할 동작
              Swal.fire({
                title: '오류!',
                text: '수정 처리 중 오류가 발생했습니다.',
                icon: 'error'
              });
              console.log(error);
            }
          });
        } else {
          // 취소 선택 시 추가적인 동작이 필요하면 이곳에 추가
          Swal.fire({
            title: "수정 취소됨!",
            text: "수정이 취소되었습니다.",
            icon: "info"
          });
        }
      });
    }); //예약수정 end

    // 예약 결제하기
    $(document).on('click', '#payReservation', function (e) {
      e.preventDefault(); // 기본 폼 제출 방지

      //ajax, 결제 관련, 사전 검증 및 기능 작업 하기.
      var reservationItemId = $("#reservationItemId").val();
      var username = $("#reservationName2").val();
      var phone = $("#reservationPhone").val();
      var address = $("#reservationAddress").val();
      var price2 = $("#selectedItemPrice").val();
      var zipCode = address.match(/\d{5}/)[0];
      var reservationItemName = $("#selectedItemName").val();
      var merchant_uid = "O" + new Date().getTime(); // 고유한 주문번호 생성
      console.log("username : " + username)
      console.log("phone : " + phone)
      console.log("address : " + address)
      console.log("price2 : " + price2)
      console.log("zipCode : " + zipCode)
      console.log("reservationItemId : " + reservationItemId)
      console.log("merchant_uid : " + merchant_uid)

      Swal.fire({
        title: "결제할까요?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, pay it!"
      }).then((result) => {
        if (result.isConfirmed) {

          // 사전검증
          $.ajax({
            url: "http://localhost:8080/api/payments/prepare",
            method: "post",
            contentType: "application/json",
            headers: { "Content-Type": "application/json" ,
              "Authorization": "Bearer " + localStorage.getItem("accessToken")},
            data: JSON.stringify({
              merchant_uid: merchant_uid, // 가맹점 주문번호
              amount: price2 // 결제 예정금액

            }),
            success: function(response) {
              // 요청이 성공했을 때 실행되는 콜백 함수
              console.log("사전 검증 Success:", response);

              //결제 진행하기.
              var IMP = window.IMP;
              IMP.init('imp18751406'); // 가맹점 식별코드 입력


              //결제 사후 검증 하기.

              // 결제 후, 내용 디비 저장.

              IMP.request_pay({
                        pg: "html5_inicis",           // 등록된 pg사 (적용된 pg사는 KG이니시스)
                        pay_method: "card",           // 결제방식: card(신용카드), trans(실시간계좌이체), vbank(가상계좌), phone(소액결제)
                        // 확인 테스트시, 해당 아이디를 매번 변경해서 확인 해보기.
                        merchant_uid: merchant_uid,   // 주문번호
                        name: reservationItemName,                  // 상품명
                        amount: price2,           // 금액
                        buyer_name: username,         // 주문자
                        buyer_tel: phone,             // 전화번호 (필수입력)
                        buyer_addr: address,    		  // 주소
                        buyer_postcode: zipCode          // 우편번호
                      }, function (rsp) {
                        if (rsp.success) {

                          $.ajax({
                            url: "http://localhost:8080/api/payments/validate",
                            method: "POST",
                            contentType: "application/json",
                            headers: { "Content-Type": "application/json" ,
                              "Authorization": "Bearer " + localStorage.getItem("accessToken")},
                            data: JSON.stringify({
                              imp_uid: rsp.imp_uid,
                              merchant_uid: rsp.merchant_uid,
                            }),
                          }).done(function (data) {
                            var msg = '사후 검증 성공.';
                            console.log(msg);



                            // 검증 후 결제 정보 & 주문 정보 DB 저장
                            // 결제 정보 DB 저장
                            // 주문 상품 정보 DB 저장
                            var msg = '결제가 완료되었습니다. 결제 정보 & 주문 정보 DB 저장 ';
                            console.log(msg);

                            const id = $('#reservationItemId').val()

                            //결제 테이블에 저장.
                            var paymentInfo = {
                              "reservationItem": rsp.merchant_uid,
                              "price": rsp.paid_amount,
                              "paymentTime": new Date(rsp.paid_at * 1000).toISOString(),
                              // "pay_method": rsp.pay_method,
                              // "name": rsp.name,
                              // "amount": rsp.paid_amount,
                              // "phone": rsp.buyer_tel,
                              // "addr": rsp.buyer_addr,
                              // "post": rsp.buyer_postcode,
                              // "recipient": recipient
                            }

                            $.ajax({
                              type: "post",
                              url: "http://localhost:8080/api/payments/" + id,
                              contentType: "application/json",
                              headers: { "Content-Type": "application/json" ,
                                "Authorization": "Bearer " + localStorage.getItem("accessToken")},
                              data: JSON.stringify(paymentInfo),
                              success: function (response) {
                                console.log("결제정보 저장 완료");
                              }
                            });



                            var buyerInfo = {
                              "merchant_uid": rsp.merchant_uid,
                              "userId": rsp.buyer_name,
                              "pay_method": rsp.pay_method,
                              "name": rsp.name,
                              "amount": rsp.paid_amount,
                              "phone": rsp.buyer_tel,
                              "addr": rsp.buyer_addr,
                              "post": rsp.buyer_postcode,
                              // "recipient": recipient
                            }



                            $.ajax({
                              type: "post",
                              url: "http://localhost:8080/api/save_buyerInfo",
                              contentType: "application/json",
                              headers: { "Content-Type": "application/json" ,
                                "Authorization": "Bearer " + localStorage.getItem("accessToken")},
                              data: JSON.stringify(buyerInfo),
                              success: function (response) {
                                console.log("결제정보 저장 완료");
                              }
                            });

                            //주문 정보 DB 저장
                            var orderInfo = {
                              "merchant_uid": rsp.merchant_uid,
                              "userId":  rsp.buyer_name,
                              "gcode": rsp.pay_method,
                              "gname": rsp.name,
                              // "gprice": gprice,
                              // "gimage": gimage,
                              // "gcolor": gcolor,
                              // "gsize": gsize,
                              // "gamount": gamount,
                              // "recipient": recipient,
                              "post": rsp.buyer_postcode,
                              "addr": rsp.buyer_addr,
                              "phone": rsp.buyer_tel,
                              // "cartid": cartid
                            }

                            $.ajax({
                              type: "post",
                              url: "http://localhost:8080/api/save_orderInfo",
                              contentType: "application/json",
                              headers: { "Content-Type": "application/json" ,
                                "Authorization": "Bearer " + localStorage.getItem("accessToken")},
                              data: JSON.stringify(orderInfo),
                              success: function (response) {
                                console.log("주문완료");
                                Swal.fire({
                                  text: "결제완료&결제&주문정보저장",
                                  icon: 'success',
                                  confirmButtonColor: '#3085d6',

                                }).then(() => {
                                  window.location.href = '/reservation-items';
                                });
                              }
                            });

                            //
                            // Swal.fire({
                            //   title: "결제완료",
                            //   // text: `결제완료.${username}, 폰: ${phone}, 주소: ${address}, 예약_상품_아이디 : ${reservationItemId}`,
                            //   icon: "success"
                            // });

                          });



                        } else {
                          var msg = '결제를 실패하였습니다.';
                          Swal.fire({
                            title: "결제실패",
                            // text: `결제완료.${username}, 폰: ${phone}, 주소: ${address}, 예약_상품_아이디 : ${reservationItemId}`,
                            icon: "error"
                          });
                        }
                      }
              );


            },
            error: function(jqXHR, textStatus, errorThrown) {
              // 요청이 실패했을 때 실행되는 콜백 함수
              // alert("사전 검증 실패 : " + textStatus)
              console.error("사전 검증  Error:", textStatus, errorThrown);
            }
          });

        }})
    }); //예약결제 end


  }); //end

  // 음수 입력을 막고, 음수가 입력되면 자동으로 1로 변경하는 함수
  document.getElementById('reservationCount').addEventListener('input', function () {
    let value = parseInt(this.value);
    if (value < 1) {
      this.value = 1;  // 음수 입력 시 자동으로 1로 설정
    }
  });

  document.addEventListener("DOMContentLoaded", function() {
    const payStatus = document.getElementById("payStatus").value;

    const updateButton = document.getElementById("updateReservation");
    const cancelButton = document.getElementById("cancleReservation");
    const payButton = document.getElementById("payReservation");
    const itemList = document.getElementById("jsonResult");
    const itemPaging = document.getElementById("paginationContainer");

    if (payStatus === "결제완료") {
      updateButton.style.display = "none";
      cancelButton.style.display = "none";
      payButton.style.display = "none";
      itemList.style.display = "none";
      itemPaging.style.display = "none";
    }
  });

</script>

</body>
</html>